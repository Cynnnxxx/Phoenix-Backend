const { MessageEmbed } = require("discord.js");const User = require("../../../model/user.js");const Profiles = require("../../../model/profiles.js");const axios = require("axios");const itemTypeMap = {    "AthenaCharacter": "Skins",    "AthenaPickaxe": "Pickaxes",    "AthenaGlider": "Gliders",    "AthenaDance": "Emotes",    "AthenaBackpack": "Backpacks",    "AthenaItemWrap": "Wraps",    "AthenaLoadingScreen": "Loading Screens",    "AthenaMusicPack": "Music Packs"};async function getItemInfoById(itemId) {    try {        const response = await axios.get(`https://fortnite-api.com/v2/cosmetics/br/search?id=${encodeURIComponent(itemId)}`, {            timeout: 5000        });        if (response.data && response.data.data) {            return response.data.data;        }    } catch (error) {        try {            const nameFromId = itemId.replace(/^CID_|^PID_|^EID_|^BID_|^GID_|^WID_|^LSID_|^MPID_/, "").replace(/_/g, " ");            const response = await axios.get(`https://fortnite-api.com/v2/cosmetics/br/search?name=${encodeURIComponent(nameFromId)}`, {                timeout: 5000            });            if (response.data && response.data.data) {                return response.data.data;            }        } catch (err) {            return null;        }    }    return null;}async function getItemInfoByName(itemName) {    try {        const response = await axios.get(`https://fortnite-api.com/v2/cosmetics/br/search?name=${encodeURIComponent(itemName)}`, {            timeout: 5000        });        if (response.data && response.data.data) {            return response.data.data;        }    } catch (error) {        return null;    }    return null;}module.exports = {    commandInfo: {        name: "yourlocker",        description: "Shows all items in your locker (skins, pickaxes, emotes, etc.) with images."    },    execute: async (interaction) => {        await interaction.deferReply({ ephemeral: true });        try {            const user = await User.findOne({ discordId: interaction.user.id });            if (!user) {                return interaction.editReply({ content: "You do not have a registered account!", ephemeral: true });            }            const profile = await Profiles.findOne({ accountId: user.accountId });            if (!profile || !profile.profiles || !profile.profiles.athena || !profile.profiles.athena.items) {                return interaction.editReply({ content: "Your profile could not be found or is empty.", ephemeral: true });            }            const athenaItems = profile.profiles.athena.items;            const itemsByType = {};            for (const [itemKey, itemData] of Object.entries(athenaItems)) {                if (itemKey === "sandbox_loadout" || itemData.templateId?.includes("CosmeticLocker")) {                    continue;                }                const templateId = itemData.templateId || "";                const [itemType] = templateId.split(":");                if (itemTypeMap[itemType]) {                    const typeName = itemTypeMap[itemType];                    if (!itemsByType[typeName]) {                        itemsByType[typeName] = [];                    }                    const itemId = itemKey.split(":")[1] || itemKey;                    itemsByType[typeName].push({                        key: itemKey,                        id: itemId,                        templateId: templateId,                        itemData: itemData                    });                }            }            if (Object.keys(itemsByType).length === 0) {                return interaction.editReply({ content: "Your locker is empty! You don't have any cosmetics yet.", ephemeral: true });            }            const embeds = [];            let totalItems = 0;            for (const [typeName, items] of Object.entries(itemsByType)) {                totalItems += items.length;                await interaction.editReply({ content: `Loading ${typeName}... (${items.length} items)`, ephemeral: true });                const itemInfos = [];                for (let i = 0; i < items.length; i++) {                    const item = items[i];                    let itemInfo = await getItemInfoById(item.id);                    if (!itemInfo) {                        const possibleName = item.id.replace(/^(CID_|PID_|EID_|BID_|GID_|WID_|LSID_|MPID_)/, "")                            .replace(/_/g, " ")                            .replace(/\b\w/g, l => l.toUpperCase());                        itemInfo = await getItemInfoByName(possibleName);                    }                    itemInfos.push({                        ...item,                        apiInfo: itemInfo                    });                    if (i < items.length - 1) {                        await new Promise(resolve => setTimeout(resolve, 150));                    }                }                const itemsPerEmbed = 6;                const chunks = [];                for (let i = 0; i < itemInfos.length; i += itemsPerEmbed) {                    chunks.push(itemInfos.slice(i, i + itemsPerEmbed));                }                for (let chunkIndex = 0; chunkIndex < chunks.length; chunkIndex++) {                    const chunk = chunks[chunkIndex];                    const embed = new MessageEmbed()                        .setColor("BLUE")                        .setTitle(`${typeName} ${chunks.length > 1 ? `(${chunkIndex + 1}/${chunks.length})` : ""}`)                        .setTimestamp()                        .setFooter({                            text: `Pulse â€¢ ${items.length} total`,                            iconURL: "https://i.imgur.com/VKPcwAJ.png"                        });                    const fields = [];                    let imageSet = false;                    for (const item of chunk) {                        if (item.apiInfo && item.apiInfo.images) {                            const imageUrl = item.apiInfo.images.icon || item.apiInfo.images.smallIcon;                            const itemName = item.apiInfo.name || item.id;                            if (!imageSet && imageUrl) {                                embed.setImage(imageUrl);                                imageSet = true;                            }                            fields.push({                                name: itemName,                                value: `[View Image](${imageUrl})`,                                inline: true                            });                        } else {                            fields.push({                                name: item.id,                                value: "Image not available",                                inline: true                            });                        }                    }                    embed.addFields(fields);                    embeds.push(embed);                }            }            const summaryEmbed = new MessageEmbed()                .setColor("GOLD")                .setTitle("ðŸŽ’ Your Locker")                .setDescription(`**Total Items: ${totalItems}**\n\n${Object.entries(itemsByType).map(([type, items]) => `**${type}:** ${items.length}`).join("\n")}`)                .setThumbnail(interaction.user.avatarURL({ format: 'png', dynamic: true, size: 256 }))                .setTimestamp()                .setFooter({                    text: "Pulse",                    iconURL: "https://i.imgur.com/VKPcwAJ.png"                });            const allEmbeds = [summaryEmbed, ...embeds].slice(0, 10);            if (embeds.length + 1 > 10) {                await interaction.editReply({ embeds: allEmbeds, ephemeral: true });                for (let i = 10; i < embeds.length + 1; i += 10) {                    const nextBatch = embeds.slice(i - 1, i + 9);                    await interaction.followUp({ embeds: nextBatch, ephemeral: true });                }            } else {                await interaction.editReply({ embeds: allEmbeds, ephemeral: true });            }        } catch (error) {            console.error("Error fetching locker:", error);            interaction.editReply({ content: "An error occurred while fetching your locker. Please try again later.", ephemeral: true });        }    }}